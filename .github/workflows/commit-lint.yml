name: Commit Message Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

jobs:
  commitlint:
    name: Validate Commit Messages
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install commitlint
        run: |
          npm install --save-dev @commitlint/cli @commitlint/config-conventional
      
      - name: Create commitlint config
        run: |
          echo "module.exports = {
            extends: ['@commitlint/config-conventional'],
            rules: {
              'type-enum': [
                2,
                'always',
                [
                  'feat',     // æ–°æ©Ÿèƒ½
                  'fix',      // ãƒã‚°ä¿®æ­£
                  'docs',     // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã¿ã®å¤‰æ›´
                  'style',    // ã‚³ãƒ¼ãƒ‰ã®æ„å‘³ã«å½±éŸ¿ã—ãªã„å¤‰æ›´ï¼ˆç©ºç™½ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç­‰ï¼‰
                  'refactor', // ãƒã‚°ä¿®æ­£ã‚„æ©Ÿèƒ½è¿½åŠ ã‚’ä¼´ã‚ãªã„ã‚³ãƒ¼ãƒ‰å¤‰æ›´
                  'test',     // ãƒ†ã‚¹ãƒˆã®è¿½åŠ ã‚„æ—¢å­˜ãƒ†ã‚¹ãƒˆã®ä¿®æ­£
                  'chore',    // ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ã‚„ãƒ„ãƒ¼ãƒ«ã®å¤‰æ›´
                  'perf',     // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„
                  'ci',       // CIè¨­å®šã®å¤‰æ›´
                  'revert',   // ä»¥å‰ã®ã‚³ãƒŸãƒƒãƒˆã®å–ã‚Šæ¶ˆã—
                  'build'     // ãƒ“ãƒ«ãƒ‰ã‚·ã‚¹ãƒ†ãƒ ã‚„å¤–éƒ¨ä¾å­˜é–¢ä¿‚ã®å¤‰æ›´
                ]
              ],
              'type-case': [2, 'always', 'lower-case'],
              'type-empty': [2, 'never'],
              'subject-empty': [2, 'never'],
              'subject-case': [2, 'never', ['sentence-case', 'start-case', 'pascal-case', 'upper-case']],
              'subject-full-stop': [2, 'never', '.'],
              'header-max-length': [2, 'always', 100],
              'body-leading-blank': [1, 'always'],
              'body-max-line-length': [2, 'always', 100],
              'footer-leading-blank': [1, 'always'],
              'footer-max-line-length': [2, 'always', 100]
            },
            helpUrl: 'https://www.conventionalcommits.org/'
          };" > commitlint.config.js
      
      - name: Validate PR title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "Validating PR title: $PR_TITLE"
          echo "$PR_TITLE" | npx commitlint
      
      - name: Get commit messages
        id: get_commits
        run: |
          # Get all commits in the PR
          COMMITS=$(git log --format=%B origin/${{ github.base_ref }}..HEAD)
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Validate commit messages
        run: |
          # Validate each commit message
          git log --format=%B origin/${{ github.base_ref }}..HEAD | while read -r line; do
            if [ -n "$line" ]; then
              echo "Validating: $line"
              echo "$line" | npx commitlint || {
                echo "âŒ Invalid commit message format!"
                echo ""
                echo "ğŸ“ Conventional Commitså½¢å¼ã§ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„:"
                echo ""
                echo "  <type>(<scope>): <subject>"
                echo ""
                echo "ä½¿ç”¨å¯èƒ½ãªã‚¿ã‚¤ãƒ—:"
                echo "  - feat: æ–°æ©Ÿèƒ½"
                echo "  - fix: ãƒã‚°ä¿®æ­£"
                echo "  - docs: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã¿ã®å¤‰æ›´"
                echo "  - style: ã‚³ãƒ¼ãƒ‰ã®æ„å‘³ã«å½±éŸ¿ã—ãªã„å¤‰æ›´"
                echo "  - refactor: ãƒã‚°ä¿®æ­£ã‚„æ©Ÿèƒ½è¿½åŠ ã‚’ä¼´ã‚ãªã„ã‚³ãƒ¼ãƒ‰å¤‰æ›´"
                echo "  - test: ãƒ†ã‚¹ãƒˆã®è¿½åŠ ã‚„ä¿®æ­£"
                echo "  - chore: ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ã‚„ãƒ„ãƒ¼ãƒ«ã®å¤‰æ›´"
                echo "  - perf: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„"
                echo "  - ci: CIè¨­å®šã®å¤‰æ›´"
                echo ""
                echo "ä¾‹:"
                echo "  feat: ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æ©Ÿèƒ½ã‚’è¿½åŠ "
                echo "  fix(auth): ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£"
                echo "  docs: READMEã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †ã‚’è¿½åŠ "
                echo ""
                echo "è©³ç´°: https://www.conventionalcommits.org/"
                exit 1
              }
            fi
          done
      
      - name: Check for breaking changes
        run: |
          # Check for breaking changes in commit messages
          if git log --format=%B origin/${{ github.base_ref }}..HEAD | grep -E "(BREAKING CHANGE:|^[a-z]+!:)"; then
            echo "âš ï¸  ç ´å£Šçš„å¤‰æ›´ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼"
            echo "PRã®èª¬æ˜ã«å½±éŸ¿ç¯„å›²ã¨ç§»è¡Œæ–¹æ³•ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚"
          fi
      
      - name: Generate commit summary
        if: always()
        run: |
          echo "## ğŸ“Š ã‚³ãƒŸãƒƒãƒˆã‚µãƒãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Count commits by type
          echo "### ã‚³ãƒŸãƒƒãƒˆã‚¿ã‚¤ãƒ—åˆ¥é›†è¨ˆ:" >> $GITHUB_STEP_SUMMARY
          echo "| ã‚¿ã‚¤ãƒ— | ä»¶æ•° |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          
          for type in feat fix docs style refactor test chore perf ci; do
            count=$(git log --format=%s origin/${{ github.base_ref }}..HEAD | grep -c "^$type:" || true)
            if [ $count -gt 0 ]; then
              echo "| $type | $count |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # List all commits
          echo "### ã‚³ãƒŸãƒƒãƒˆä¸€è¦§:" >> $GITHUB_STEP_SUMMARY
          git log --format="- %s (%h)" origin/${{ github.base_ref }}..HEAD >> $GITHUB_STEP_SUMMARY