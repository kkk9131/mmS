name: Workflow Integration Test

on:
  workflow_dispatch:
  schedule:
    # æ¯Žé€±æœˆæ›œæ—¥ã®æœ9æ™‚ã«å®Ÿè¡Œ
    - cron: '0 0 * * 1'

jobs:
  test-workflows:
    name: Test All Workflows
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Validate workflow files
        run: |
          echo "ðŸ” Validating all workflow files..."
          
          # YAMLã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
          for file in .github/workflows/*.yml; do
            echo "Checking: $file"
            python -c "import yaml; yaml.safe_load(open('$file'))" || {
              echo "âŒ Invalid YAML in $file"
              exit 1
            }
          done
          
          echo "âœ… All workflow files have valid YAML syntax"
      
      - name: Check required workflows
        run: |
          echo "ðŸ“‹ Checking required workflows..."
          
          REQUIRED_WORKFLOWS=(
            "ci.yml"
            "release.yml"
            "commit-lint.yml"
            "error-notification.yml"
          )
          
          for workflow in "${REQUIRED_WORKFLOWS[@]}"; do
            if [ -f ".github/workflows/$workflow" ]; then
              echo "âœ… Found: $workflow"
            else
              echo "âŒ Missing: $workflow"
              exit 1
            fi
          done
      
      - name: Test branch protection config
        run: |
          echo "ðŸ›¡ï¸ Validating branch protection configuration..."
          
          if [ -f ".github/branch-protection.yml" ]; then
            echo "âœ… Branch protection config exists"
            
            # Check for required branches
            if grep -q "name: main" .github/branch-protection.yml && \
               grep -q "name: develop" .github/branch-protection.yml; then
              echo "âœ… Main and develop branch rules defined"
            else
              echo "âŒ Missing branch protection rules"
              exit 1
            fi
          else
            echo "âŒ Branch protection config not found"
            exit 1
          fi
      
      - name: Test issue templates
        run: |
          echo "ðŸ“ Checking issue templates..."
          
          REQUIRED_TEMPLATES=(
            "bug_report.yml"
            "feature_request.yml"
            "config.yml"
          )
          
          for template in "${REQUIRED_TEMPLATES[@]}"; do
            if [ -f ".github/ISSUE_TEMPLATE/$template" ]; then
              echo "âœ… Found: $template"
            else
              echo "âŒ Missing: $template"
              exit 1
            fi
          done
      
      - name: Test PR template
        run: |
          echo "ðŸ”„ Checking pull request template..."
          
          if [ -f ".github/pull_request_template.md" ]; then
            echo "âœ… PR template exists"
          else
            echo "âŒ PR template not found"
            exit 1
          fi
      
      - name: Test CODEOWNERS
        run: |
          echo "ðŸ‘¥ Checking CODEOWNERS file..."
          
          if [ -f ".github/CODEOWNERS" ]; then
            echo "âœ… CODEOWNERS file exists"
            
            # Basic validation
            if grep -q "@" .github/CODEOWNERS; then
              echo "âœ… CODEOWNERS contains team/user assignments"
            else
              echo "âš ï¸ Warning: CODEOWNERS file exists but contains no assignments"
            fi
          else
            echo "âŒ CODEOWNERS file not found"
            exit 1
          fi
      
      - name: Simulate CI workflow
        run: |
          echo "ðŸš€ Simulating CI workflow..."
          
          # Install dependencies
          npm ci
          
          # Run linting
          echo "Running ESLint..."
          npm run lint || echo "âš ï¸ Linting warnings detected"
          
          # Run type check
          echo "Running TypeScript check..."
          npx tsc --noEmit || {
            echo "âŒ TypeScript errors detected"
            exit 1
          }
          
          # Run tests
          echo "Running tests..."
          npm test || echo "âš ï¸ Some tests failed or no tests found"
          
          # Build check
          echo "Running build..."
          npm run build || {
            echo "âŒ Build failed"
            exit 1
          }
      
      - name: Test commit message validation
        run: |
          echo "ðŸ“ Testing commit message validation..."
          
          # Install commitlint locally for testing
          npm install --save-dev @commitlint/cli @commitlint/config-conventional
          
          # Create test commit messages
          echo "feat: add new feature" | npx commitlint || {
            echo "âŒ Valid commit message was rejected"
            exit 1
          }
          
          echo "bad commit message" | npx commitlint && {
            echo "âŒ Invalid commit message was accepted"
            exit 1
          } || echo "âœ… Invalid commit message correctly rejected"
      
      - name: Check workflow permissions
        run: |
          echo "ðŸ” Checking workflow permissions..."
          
          # Check if workflows have appropriate permissions
          for file in .github/workflows/*.yml; do
            if grep -q "permissions:" "$file"; then
              echo "âœ… $(basename $file) has permissions defined"
            else
              echo "âš ï¸ $(basename $file) has no explicit permissions"
            fi
          done
      
      - name: Generate test report
        if: always()
        run: |
          echo "## ðŸ“Š Workflow Integration Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Completed Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. YAML syntax validation" >> $GITHUB_STEP_SUMMARY
          echo "2. Required workflows presence" >> $GITHUB_STEP_SUMMARY
          echo "3. Branch protection configuration" >> $GITHUB_STEP_SUMMARY
          echo "4. Issue templates validation" >> $GITHUB_STEP_SUMMARY
          echo "5. Pull request template check" >> $GITHUB_STEP_SUMMARY
          echo "6. CODEOWNERS file validation" >> $GITHUB_STEP_SUMMARY
          echo "7. CI workflow simulation" >> $GITHUB_STEP_SUMMARY
          echo "8. Commit message validation" >> $GITHUB_STEP_SUMMARY
          echo "9. Workflow permissions audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“… Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Review any warnings or failures above" >> $GITHUB_STEP_SUMMARY
          echo "- Update configurations as needed" >> $GITHUB_STEP_SUMMARY
          echo "- Run this test regularly to ensure workflow health" >> $GITHUB_STEP_SUMMARY