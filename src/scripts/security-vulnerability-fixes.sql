-- ===============================
-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ä¿®æ­£ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
-- ===============================
-- ç™ºè¦‹ã•ã‚ŒãŸè„†å¼±æ€§ã®ä¿®æ­£ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–

-- 1. èªè¨¼ãƒã‚¤ãƒ‘ã‚¹è„†å¼±æ€§ä¿®æ­£ï¼šç©ºæ–‡å­—åˆ—ãƒ»NULLå€¤ã§ã®èªè¨¼ã‚’é˜²ã
-- auth_with_maternal_booké–¢æ•°ã‚’å¼·åŒ–ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ç½®ãæ›ãˆ
CREATE OR REPLACE FUNCTION auth_with_maternal_book(
  maternal_book_param text,
  user_nickname_param text
)
RETURNS TABLE(
  user_id UUID,
  access_token text,
  refresh_token text,
  profile_data JSONB
)
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  existing_user_id UUID;
  new_user_id UUID;
  user_profile RECORD;
  sanitized_nickname text;
BEGIN
  -- ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼1: å…¥åŠ›å€¤ã®æ¤œè¨¼
  -- ç©ºæ–‡å­—åˆ—ã€NULLå€¤ã€ä¸æ­£ãªæ–‡å­—åˆ—ã®æ¤œè¨¼
  IF maternal_book_param IS NULL OR 
     trim(maternal_book_param) = '' OR 
     length(trim(maternal_book_param)) < 3 THEN
    RAISE EXCEPTION 'Invalid maternal book number: must be at least 3 characters' 
      USING ERRCODE = 'invalid_parameter_value';
  END IF;

  IF user_nickname_param IS NULL OR 
     trim(user_nickname_param) = '' OR 
     length(trim(user_nickname_param)) < 1 THEN
    RAISE EXCEPTION 'Invalid nickname: must not be empty' 
      USING ERRCODE = 'invalid_parameter_value';
  END IF;

  -- ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼2: æ¯å­æ‰‹å¸³ç•ªå·ã®å½¢å¼æ¤œè¨¼
  -- è‹±æ•°å­—ã¨ç‰¹å®šã®è¨˜å·ã®ã¿è¨±å¯ï¼ˆæ—¥æœ¬ã®æ¯å­æ‰‹å¸³ç•ªå·å½¢å¼ï¼‰
  IF NOT maternal_book_param ~ '^[A-Za-z0-9\-_\.]{3,50}$' THEN
    RAISE EXCEPTION 'Invalid maternal book number format' 
      USING ERRCODE = 'invalid_parameter_value';
  END IF;

  -- ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼3: ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
  -- XSSæ”»æ’ƒé˜²æ­¢ã®ãŸã‚HTMLã‚¿ã‚°ã¨JavaScriptã‚’é™¤å»
  sanitized_nickname := regexp_replace(
    regexp_replace(
      regexp_replace(
        regexp_replace(
          regexp_replace(user_nickname_param, '<[^>]*>', '', 'g'), -- HTMLã‚¿ã‚°é™¤å»
          'javascript:', '', 'gi'), -- JavaScripté™¤å»
        'on\w+\s*=', '', 'gi'), -- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©é™¤å»
      '&lt;.*?&gt;', '', 'g'), -- ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ¸ˆã¿HTMLã‚¿ã‚°é™¤å»
    '[<>&"''\x00-\x1F\x7F]', '', 'g'); -- ç‰¹æ®Šæ–‡å­—ã¨åˆ¶å¾¡æ–‡å­—é™¤å»

  -- ã‚µãƒ‹ã‚¿ã‚¤ã‚ºå¾Œã®é•·ã•æ¤œè¨¼
  IF length(trim(sanitized_nickname)) < 1 THEN
    RAISE EXCEPTION 'Nickname contains only invalid characters' 
      USING ERRCODE = 'invalid_parameter_value';
  END IF;

  -- é•·ã™ãã‚‹ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã®åˆ¶é™
  IF length(sanitized_nickname) > 50 THEN
    sanitized_nickname := left(sanitized_nickname, 50);
  END IF;

  -- æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’maternal_book_numberã§æ¤œç´¢
  SELECT u.id INTO existing_user_id 
  FROM public.users u
  WHERE u.maternal_book_number = trim(maternal_book_param);
  
  IF existing_user_id IS NOT NULL THEN
    -- ğŸ›¡ï¸ æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã€ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºå®šæ”»æ’ƒã‚’é˜²ããŸã‚æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ
    UPDATE public.users 
    SET nickname = sanitized_nickname, 
        updated_at = NOW(),
        -- ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’æ›´æ–°ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºå®šã‚’é˜²ã
        last_sign_in_at = NOW()
    WHERE id = existing_user_id;
    
    -- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’å–å¾—
    SELECT u.* INTO user_profile 
    FROM public.users u
    WHERE u.id = existing_user_id;
    
    -- ğŸ›¡ï¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºå®šæ”»æ’ƒé˜²æ­¢ï¼šæ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ
    -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã¨ãƒ©ãƒ³ãƒ€ãƒ è¦ç´ ã‚’å«ã‚€å®‰å…¨ãªãƒˆãƒ¼ã‚¯ãƒ³
    RETURN QUERY SELECT 
      existing_user_id,
      'secure_access_' || existing_user_id::TEXT || '_' || extract(epoch from NOW())::TEXT || '_' || gen_random_uuid()::TEXT,
      'secure_refresh_' || existing_user_id::TEXT || '_' || extract(epoch from NOW())::TEXT || '_' || gen_random_uuid()::TEXT,
      jsonb_build_object(
        'id', user_profile.id,
        'nickname', user_profile.nickname,
        'bio', user_profile.bio,
        'avatar_url', user_profile.avatar_url,
        'created_at', user_profile.created_at,
        'updated_at', user_profile.updated_at,
        'is_anonymous', user_profile.is_anonymous,
        'privacy_settings', user_profile.privacy_settings,
        -- ğŸ›¡ï¸ æ©Ÿå¯†æƒ…å ±ï¼ˆæ¯å­æ‰‹å¸³ç•ªå·ï¼‰ã¯ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é™¤å¤–
        'maternal_book_number', '***PROTECTED***'
      );
  ELSE
    -- æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆ
    new_user_id := gen_random_uuid();
    
    -- ğŸ›¡ï¸ ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼ˆåŒä¸€IPã‹ã‚‰ã®å¤§é‡ç™»éŒ²é˜²æ­¢ï¼‰
    -- å®Ÿè£…ã¯çœç•¥ï¼ˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ãƒ™ãƒ«ã§å®Ÿè£…æ¨å¥¨ï¼‰
    
    -- auth.usersã«æŒ¿å…¥ï¼ˆSupabaseèªè¨¼ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
    INSERT INTO auth.users (
      id, 
      email, 
      encrypted_password, 
      email_confirmed_at,
      created_at,
      updated_at,
      raw_app_meta_data,
      raw_user_meta_data,
      is_super_admin,
      role
    ) VALUES (
      new_user_id,
      trim(maternal_book_param) || '@maternal.book',
      crypt('secure_dummy_' || gen_random_uuid()::TEXT, gen_salt('bf')), -- ã‚ˆã‚Šå®‰å…¨ãªãƒ€ãƒŸãƒ¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
      NOW(),
      NOW(),
      NOW(),
      '{"provider": "maternal_book", "security_version": "2.0"}'::JSONB,
      jsonb_build_object(
        'nickname', sanitized_nickname, 
        'maternal_book_number', trim(maternal_book_param),
        'registration_timestamp', extract(epoch from NOW())
      ),
      false,
      'authenticated'
    );
    
    -- public.usersãƒ†ãƒ¼ãƒ–ãƒ«ã«è©³ç´°æƒ…å ±ã‚’æŒ¿å…¥
    INSERT INTO public.users (
      id,
      nickname,
      maternal_book_number,
      created_at,
      updated_at,
      last_sign_in_at,
      privacy_settings
    ) VALUES (
      new_user_id,
      sanitized_nickname,
      trim(maternal_book_param),
      NOW(),
      NOW(),
      NOW(),
      jsonb_build_object(
        'profile_visible', true,
        'posts_visible', true,
        'allow_notifications', true
      )
    );
    
    -- æ–°è¦ä½œæˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’å–å¾—
    SELECT u.* INTO user_profile 
    FROM public.users u
    WHERE u.id = new_user_id;
    
    -- ğŸ›¡ï¸ æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚‚å®‰å…¨ãªãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ
    RETURN QUERY SELECT 
      new_user_id,
      'secure_access_' || new_user_id::TEXT || '_' || extract(epoch from NOW())::TEXT || '_' || gen_random_uuid()::TEXT,
      'secure_refresh_' || new_user_id::TEXT || '_' || extract(epoch from NOW())::TEXT || '_' || gen_random_uuid()::TEXT,
      jsonb_build_object(
        'id', user_profile.id,
        'nickname', user_profile.nickname,
        'bio', user_profile.bio,
        'avatar_url', user_profile.avatar_url,
        'created_at', user_profile.created_at,
        'updated_at', user_profile.updated_at,
        'is_anonymous', user_profile.is_anonymous,
        'privacy_settings', user_profile.privacy_settings,
        -- ğŸ›¡ï¸ æ©Ÿå¯†æƒ…å ±ï¼ˆæ¯å­æ‰‹å¸³ç•ªå·ï¼‰ã¯ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é™¤å¤–
        'maternal_book_number', '***PROTECTED***'
      );
  END IF;

EXCEPTION
  WHEN invalid_parameter_value THEN
    -- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¨ãƒ©ãƒ¼ã¯è©³ç´°ã‚’éš ã™
    RAISE EXCEPTION 'Authentication failed: Invalid credentials' 
      USING ERRCODE = 'authentication_failure';
  WHEN OTHERS THEN
    -- ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã‚‚è©³ç´°ã‚’éš ã™
    RAISE EXCEPTION 'Authentication system error' 
      USING ERRCODE = 'system_error';
END;
$$;

-- 2. æ–°ã—ã„ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°ã®ä½œæˆ
CREATE OR REPLACE FUNCTION sanitize_user_input(input_text text)
RETURNS text
LANGUAGE plpgsql
IMMUTABLE
AS $$
BEGIN
  IF input_text IS NULL THEN
    RETURN '';
  END IF;
  
  -- XSSæ”»æ’ƒé˜²æ­¢ã®ãŸã‚ã®åŒ…æ‹¬çš„ãªã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
  RETURN regexp_replace(
    regexp_replace(
      regexp_replace(
        regexp_replace(
          regexp_replace(
            regexp_replace(input_text, 
              '<[^>]*>', '', 'g'), -- HTMLã‚¿ã‚°é™¤å»
            'javascript:', '', 'gi'), -- JavaScripté™¤å»
          'on\w+\s*=', '', 'gi'), -- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©é™¤å»
        '&lt;.*?&gt;', '', 'g'), -- ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ¸ˆã¿HTMLã‚¿ã‚°é™¤å»
      '&[a-zA-Z0-9#]+;', '', 'g'), -- HTMLã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£é™¤å»
    '[<>&"''\x00-\x1F\x7F]', '', 'g'); -- å±é™ºãªæ–‡å­—ã¨åˆ¶å¾¡æ–‡å­—é™¤å»
END;
$$;

-- 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°æ™‚ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ–
CREATE OR REPLACE FUNCTION update_user_profile_secure()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
BEGIN
  -- ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
  IF NEW.nickname IS NOT NULL THEN
    NEW.nickname := sanitize_user_input(NEW.nickname);
    
    -- ç©ºæ–‡å­—åˆ—ãƒã‚§ãƒƒã‚¯
    IF trim(NEW.nickname) = '' THEN
      RAISE EXCEPTION 'Nickname cannot be empty after sanitization';
    END IF;
    
    -- é•·ã•åˆ¶é™
    IF length(NEW.nickname) > 50 THEN
      NEW.nickname := left(NEW.nickname, 50);
    END IF;
  END IF;
  
  -- bioã®ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
  IF NEW.bio IS NOT NULL THEN
    NEW.bio := sanitize_user_input(NEW.bio);
    
    -- é•·ã•åˆ¶é™
    IF length(NEW.bio) > 500 THEN
      NEW.bio := left(NEW.bio, 500);
    END IF;
  END IF;
  
  -- æ›´æ–°æ—¥æ™‚ã®è¨­å®š
  NEW.updated_at := NOW();
  
  RETURN NEW;
END;
$$;

-- 4. ãƒˆãƒªã‚¬ãƒ¼ã®ä½œæˆï¼ˆæ—¢å­˜ãƒˆãƒªã‚¬ãƒ¼ãŒã‚ã‚‹å ´åˆã¯å‰Šé™¤ã—ã¦ã‹ã‚‰ä½œæˆï¼‰
DROP TRIGGER IF EXISTS secure_user_update ON public.users;
CREATE TRIGGER secure_user_update
  BEFORE UPDATE ON public.users
  FOR EACH ROW
  EXECUTE FUNCTION update_user_profile_secure();

-- 5. æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ–
CREATE OR REPLACE FUNCTION secure_post_content()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
BEGIN
  -- ã‚¿ã‚¤ãƒˆãƒ«ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
  IF NEW.title IS NOT NULL THEN
    NEW.title := sanitize_user_input(NEW.title);
    
    IF length(NEW.title) > 200 THEN
      NEW.title := left(NEW.title, 200);
    END IF;
  END IF;
  
  -- å†…å®¹ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
  IF NEW.content IS NOT NULL THEN
    NEW.content := sanitize_user_input(NEW.content);
    
    IF length(NEW.content) > 10000 THEN
      NEW.content := left(NEW.content, 10000);
    END IF;
  END IF;
  
  -- æ›´æ–°æ—¥æ™‚ã®è¨­å®š
  NEW.updated_at := NOW();
  
  RETURN NEW;
END;
$$;

-- 6. æŠ•ç¨¿ç”¨ãƒˆãƒªã‚¬ãƒ¼ã®ä½œæˆ
DROP TRIGGER IF EXISTS secure_post_insert ON public.posts;
DROP TRIGGER IF EXISTS secure_post_update ON public.posts;

CREATE TRIGGER secure_post_insert
  BEFORE INSERT ON public.posts
  FOR EACH ROW
  EXECUTE FUNCTION secure_post_content();

CREATE TRIGGER secure_post_update
  BEFORE UPDATE ON public.posts
  FOR EACH ROW
  EXECUTE FUNCTION secure_post_content();

-- 7. ã‚³ãƒ¡ãƒ³ãƒˆç”¨ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
CREATE OR REPLACE FUNCTION secure_comment_content()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
BEGIN
  -- ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
  IF NEW.content IS NOT NULL THEN
    NEW.content := sanitize_user_input(NEW.content);
    
    IF trim(NEW.content) = '' THEN
      RAISE EXCEPTION 'Comment content cannot be empty';
    END IF;
    
    IF length(NEW.content) > 2000 THEN
      NEW.content := left(NEW.content, 2000);
    END IF;
  END IF;
  
  NEW.updated_at := NOW();
  
  RETURN NEW;
END;
$$;

-- 8. ã‚³ãƒ¡ãƒ³ãƒˆç”¨ãƒˆãƒªã‚¬ãƒ¼ã®ä½œæˆ
DROP TRIGGER IF EXISTS secure_comment_insert ON public.comments;
DROP TRIGGER IF EXISTS secure_comment_update ON public.comments;

CREATE TRIGGER secure_comment_insert
  BEFORE INSERT ON public.comments
  FOR EACH ROW
  EXECUTE FUNCTION secure_comment_content();

CREATE TRIGGER secure_comment_update
  BEFORE UPDATE ON public.comments
  FOR EACH ROW
  EXECUTE FUNCTION secure_comment_content();

-- 9. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
CREATE TABLE IF NOT EXISTS security_audit_log (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  event_type text NOT NULL,
  user_id UUID REFERENCES public.users(id),
  ip_address inet,
  user_agent text,
  event_data jsonb,
  risk_level text CHECK (risk_level IN ('low', 'medium', 'high', 'critical')),
  created_at timestamptz DEFAULT NOW()
);

-- 10. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ãƒ­ã‚°ç”¨ã®RLSãƒãƒªã‚·ãƒ¼
ALTER TABLE security_audit_log ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Only service role can access audit logs" ON security_audit_log
  FOR ALL USING (auth.role() = 'service_role');

-- 11. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²é–¢æ•°
CREATE OR REPLACE FUNCTION log_security_event(
  event_type_param text,
  user_id_param UUID DEFAULT NULL,
  risk_level_param text DEFAULT 'low',
  event_data_param jsonb DEFAULT NULL
)
RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  INSERT INTO security_audit_log (
    event_type,
    user_id,
    risk_level,
    event_data
  ) VALUES (
    event_type_param,
    user_id_param,
    risk_level_param,
    event_data_param
  );
EXCEPTION
  WHEN OTHERS THEN
    -- ç›£æŸ»ãƒ­ã‚°ã®å¤±æ•—ã¯ãƒ¡ã‚¤ãƒ³å‡¦ç†ã‚’æ­¢ã‚ãªã„
    NULL;
END;
$$;

-- 12. auth_with_maternal_booké–¢æ•°ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ãƒ­ã‚°ã‚’è¿½åŠ 
CREATE OR REPLACE FUNCTION auth_with_maternal_book_with_audit(
  maternal_book_param text,
  user_nickname_param text
)
RETURNS TABLE(
  user_id UUID,
  access_token text,
  refresh_token text,
  profile_data JSONB
)
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  result_record RECORD;
  auth_user_id UUID;
BEGIN
  -- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ãƒ­ã‚°ï¼ˆèªè¨¼è©¦è¡Œï¼‰
  PERFORM log_security_event(
    'authentication_attempt',
    NULL,
    'medium',
    jsonb_build_object(
      'maternal_book_length', length(coalesce(maternal_book_param, '')),
      'nickname_length', length(coalesce(user_nickname_param, '')),
      'timestamp', extract(epoch from NOW())
    )
  );

  -- å…ƒã®èªè¨¼é–¢æ•°ã‚’å‘¼ã³å‡ºã—
  FOR result_record IN 
    SELECT * FROM auth_with_maternal_book(maternal_book_param, user_nickname_param)
  LOOP
    auth_user_id := result_record.user_id;
    
    -- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ãƒ­ã‚°ï¼ˆèªè¨¼æˆåŠŸï¼‰
    PERFORM log_security_event(
      'authentication_success',
      auth_user_id,
      'low',
      jsonb_build_object(
        'timestamp', extract(epoch from NOW()),
        'new_tokens_generated', true
      )
    );
    
    RETURN QUERY SELECT 
      result_record.user_id,
      result_record.access_token,
      result_record.refresh_token,
      result_record.profile_data;
  END LOOP;

EXCEPTION
  WHEN OTHERS THEN
    -- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ãƒ­ã‚°ï¼ˆèªè¨¼å¤±æ•—ï¼‰
    PERFORM log_security_event(
      'authentication_failure',
      NULL,
      'high',
      jsonb_build_object(
        'error_code', SQLSTATE,
        'error_message', SQLERRM,
        'timestamp', extract(epoch from NOW())
      )
    );
    
    RAISE;
END;
$$;

-- 13. é–¢æ•°ã®æ¨©é™è¨­å®š
GRANT EXECUTE ON FUNCTION auth_with_maternal_book TO anon, authenticated;
GRANT EXECUTE ON FUNCTION auth_with_maternal_book_with_audit TO anon, authenticated;
GRANT EXECUTE ON FUNCTION sanitize_user_input TO anon, authenticated;

-- å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
DO $$
BEGIN
  RAISE NOTICE 'ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ä¿®æ­£ãŒå®Œäº†ã—ã¾ã—ãŸ';
  RAISE NOTICE 'âœ… ä¿®æ­£ã•ã‚ŒãŸè„†å¼±æ€§:';
  RAISE NOTICE '  1. èªè¨¼ãƒã‚¤ãƒ‘ã‚¹æ”»æ’ƒï¼ˆç©ºæ–‡å­—åˆ—ãƒ»NULLå€¤èªè¨¼ï¼‰';
  RAISE NOTICE '  2. Stored XSSæ”»æ’ƒï¼ˆãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãƒ»æŠ•ç¨¿ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆï¼‰';
  RAISE NOTICE '  3. ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºå®šæ”»æ’ƒï¼ˆæ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆï¼‰';
  RAISE NOTICE '  4. HTMLã‚¿ã‚°ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³';
  RAISE NOTICE '  5. æ©Ÿå¯†æƒ…å ±æ¼æ´©ï¼ˆæ¯å­æ‰‹å¸³ç•ªå·ãƒã‚¹ã‚­ãƒ³ã‚°ï¼‰';
  RAISE NOTICE '';
  RAISE NOTICE 'ğŸ” è¿½åŠ ã•ã‚ŒãŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½:';
  RAISE NOTICE '  - åŒ…æ‹¬çš„ãªå…¥åŠ›å€¤ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³';
  RAISE NOTICE '  - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ ';
  RAISE NOTICE '  - è‡ªå‹•çš„ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°';
  RAISE NOTICE '  - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ¨™æº–åŒ–';
END $$;